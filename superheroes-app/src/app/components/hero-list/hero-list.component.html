<div class="hero-list-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        Gestión de Súper Héroes
      </mat-card-title>
      <mat-card-subtitle>
        Administra tu colección de súper héroes
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Search and Add Section -->
  <mat-card class="search-card">
    <mat-card-content>
      <div class="search-section">
        <mat-form-field class="search-field" appearance="outline">
          <mat-label>Buscar héroe</mat-label>
          <input 
            matInput 
            [formControl]="searchControl"
            placeholder="Escribe el nombre del héroe..."
            data-testid="search-input">
          <mat-icon matSuffix>search</mat-icon>
          @if (searchControl.value) {
            <button 
              mat-icon-button 
              matSuffix 
              (click)="clearSearch()"
              aria-label="Limpiar búsqueda"
              data-testid="clear-search-btn">
              <mat-icon>clear</mat-icon>
            </button>
          }
        </mat-form-field>
        
        <button 
          mat-raised-button 
          color="primary" 
          (click)="onAddHero()"
          class="add-button"
          data-testid="add-hero-btn">
          <mat-icon>add</mat-icon>
          Agregar Héroe
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Heroes Table -->
  <mat-card class="table-card">
    <mat-card-content>
      @if (isLoading() && totalHeroes() === 0) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando héroes...</p>
        </div>
      } @else {
        <div class="table-container">
          <table 
            mat-table 
            [dataSource]="dataSource" 
            matSort 
            class="heroes-table"
            data-testid="heroes-table">
            
            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
              <td mat-cell *matCellDef="let hero">{{ hero.id }}</td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
              <td mat-cell *matCellDef="let hero">
                <div class="hero-name">
                  <strong>{{ hero.name }}</strong>
                  <mat-chip 
                    [color]="getStatusColor(hero.isActive)"
                    class="status-chip">
                    {{ getStatusText(hero.isActive) }}
                  </mat-chip>
                </div>
              </td>
            </ng-container>

            <!-- Alias Column -->
            <ng-container matColumnDef="alias">
              <th mat-header-cell *matHeaderCellDef>Alias</th>
              <td mat-cell *matCellDef="let hero">{{ hero.alias }}</td>
            </ng-container>

            <!-- City Column -->
            <ng-container matColumnDef="city">
              <th mat-header-cell *matHeaderCellDef>Ciudad</th>
              <td mat-cell *matCellDef="let hero">{{ hero.city }}</td>
            </ng-container>

            <!-- Powers Column -->
            <ng-container matColumnDef="powers">
              <th mat-header-cell *matHeaderCellDef>Poderes</th>
              <td mat-cell *matCellDef="let hero">
                <div class="powers-cell">
                  <mat-chip *ngFor="let power of hero.powers.slice(0, 2)" class="power-chip">
                    {{ power }}
                  </mat-chip>
                  <span *ngIf="hero.powers.length > 2" class="more-powers">
                    +{{ hero.powers.length - 2 }} más
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Power Level Column -->
            <ng-container matColumnDef="powerLevel">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nivel</th>
              <td mat-cell *matCellDef="let hero">
                <div class="power-level-cell">
                  <mat-chip [color]="getPowerLevelColor(hero.powerLevel)" class="power-level-chip">
                    {{ hero.powerLevel }}/10
                  </mat-chip>
                </div>
              </td>
            </ng-container>

            <!-- Active Status Column -->
            <ng-container matColumnDef="isActive">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let hero">
                <mat-slide-toggle
                   [checked]="hero.isActive"
                   (change)="onToggleActive(hero)"
                   [color]="hero.isActive ? 'primary' : 'warn'"
                   [attr.data-testid]="'toggle-active-' + hero.id">
                 </mat-slide-toggle>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let hero">
                <div class="actions-cell">
                   <button 
                     mat-icon-button 
                     color="accent"
                     (click)="viewHeroDetail(hero)"
                     matTooltip="Ver detalle"
                     [attr.data-testid]="'view-hero-' + hero.id">
                     <mat-icon>visibility</mat-icon>
                   </button>
                   
                   <button 
                     mat-icon-button 
                     color="primary"
                     (click)="onEditHero(hero)"
                     matTooltip="Editar héroe"
                     [attr.data-testid]="'edit-hero-' + hero.id">
                     <mat-icon>edit</mat-icon>
                   </button>
                   
                   <button 
                     mat-icon-button 
                     color="warn"
                     (click)="onDeleteHero(hero)"
                     matTooltip="Eliminar héroe"
                     [attr.data-testid]="'delete-hero-' + hero.id">
                     <mat-icon>delete</mat-icon>
                   </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <!-- No data message -->
          @if (dataSource.data.length === 0 && !(isLoading() && totalHeroes() === 0)) {
            <div class="no-data-container">
              <h3>No se encontraron héroes</h3>
              <p>
                @if (searchControl.value) {
                  No hay héroes que coincidan con "{{ searchControl.value }}"
                } @else {
                  No hay héroes registrados
                }
              </p>
              @if (!searchControl.value) {
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="onAddHero()">
                  <mat-icon>add</mat-icon>
                  Agregar Primer Héroe
                </button>
              }
            </div>
          }
        </div>

        <!-- Paginator -->
        @if (totalHeroes() > 0) {
          <div class="paginator-container">
            <mat-paginator
              #paginator
              [length]="totalHeroes()"
              [pageSize]="pageSize()"
              [pageSizeOptions]="[10]"
              [hidePageSize]="true"
              [disabled]="isPaginating()"
              (page)="onPageChange($event)"
              showFirstLastButtons
              data-testid="paginator">
            </mat-paginator>
            
            <!-- Indicador de paginación -->
            @if (isPaginating()) {
              <div class="pagination-loading">
                <mat-spinner diameter="20"></mat-spinner>
                <span>Cargando...</span>
              </div>
            }
          </div>
        }
      }
    </mat-card-content>
  </mat-card>
</div>
